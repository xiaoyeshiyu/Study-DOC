# 前提

Hyhive平台已成功搭建，可以正常创建虚拟机，并且可以和虚拟机正常通信。

# 准备

搭建VDI环境需要三个虚拟机：

1. ubuntu 14.x（部署VDIweb管理界面）
2. centos 6.x（部署cm_sg以及license-server）
3. windows 7/8/8.1/10（为VDI环境虚拟桌面做准备）

搭建VDI有三个安装包：

![安装包](http://oydlbqndl.bkt.clouddn.com/安装包.png)

1. `cm_sg.zip`为Teradici传输协议服务器安装包，解压之后上传到Centos 6.x服务器上
2. `teradici-wp-license-server-1_0_2.tar.gz`为Teradici lincense server安装包，直接上传到Centos 6.x服务器上
3. `yunjuzhen-engine-4.3.23043-installer.tgz`为VDI web管理界面安装包，上传到Ubuntu服务器上
4. `cm_sg`以及`license-server`可部署在同一个Centos 6.x服务器上

由于安装过程需要联网安装其他rpm包，所以推荐在有网络环境下安装好之后，将服务器做成镜像，到现场之后直接将镜像上传到Hyhive，然后修改虚拟机上的配置文件。

windows虚拟机需要安装两个代理软件：

![代理软件](http://oydlbqndl.bkt.clouddn.com/代理软件.png)

1. `PCoIP_agent_release_installer_2.5.4.1196_graphics.exe`和`PCoIP_agent_release_installer_2.5.4.1196_standard.exe`二选其一，其中`PCoIP_agent_release_installer_2.5.4.1196_standard.exe`安装在不带有GPU的虚拟机上，`PCoIP_agent_release_installer_2.5.4.1196_graphics.exe`安装在带有GPU的虚拟机上。
2. `flashvdi-desktop-agent-x86_64.1017.msi`可在VDI web管理界面上下载

![agent](http://oydlbqndl.bkt.clouddn.com/agent.png)

# 安装

## 安装license-server(Centos 6.x)

**以下安装过程均需要外网环境**

### 安装依赖包

安装java1.8

```shell
# yum -y install java-1.8.0-openjdk.x86_64
```

安装lsb.i686

```shell
# yum install redhat-lsb.i686
```

### 安装license-server

将`teradici-wp-license-server-1_0_2.tar.gz`上传到Centos 6.x上，解压

```shell
# tar zxvf teradici-wp-license-server-1_0_2.tar.gz
# cd teradici-license-server-1_0_2/
```

执行安装脚本

```shell
# ls
components  install.sh
# ./install.sh
```

安装过程所有选项全部用默认值，`default`即可

### 设定iptables

**可选项 ** ：如果不设定`iptables`也可以，直接将`iptables`关闭即可。

```shell
# iptables -I INPUT 1 -p tcp --dport 12345 -j ACCEPT
# iptables -I INPUT 1 -p tcp --dport 8090 -j ACCEPT
# iptables -I INPUT 1 -p tcp --dport 27000:27009 -j ACCEPT
# service iptables save
```

### 修改本机hosts

本机添加host name格式如下 `floating_ip name name`

```shell
# cat /etc/hosts
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
192.168.50.185 host-10-10-10-79 host-10-10-10-79
```

*演示Centos 6.x服务器IP为192.168.50.185*

### 重启

```shell
# reboot
```

## 安装CM_SG(Centos 6.x)

**以下安装过程需要外网环境**

### 安装

将cm_sg解压之后，上传到Centos 6.x上

```shell
# ls cm_sg/
cm_setup.sh                               cm_third_party_dependencies-1.5.0-build756.fc6b5b8.x86_64.rpm
cm_sg-1.5.0-build1385.fc6b5b8.x86_64.rpm
```

赋予可执行权限，并执行安装

```shell
# chmod 755 cm_setup.sh
# ./cm_setup.sh
```

修改ConnectionManager配置文件

```shell
# vi /etc/ConnectionManager.conf
	SecurityGatewayEnabled = true    
	BrokerType = PCoIP
	PcoipAddress = 192.168.50.184:8443    ##该IP:端口为VDI web管理界面端口
	LicenseServerAddress = 27000@192.168.50.185  ##该IP为license-server IP
```

### 设定iptables 

**可选项 ** ：如果不设定`iptables`也可以，直接将`iptables`关闭即可。

```shell
# iptables -I INPUT 1 -p tcp --dport 443 -j ACCEPT
# iptables -I INPUT 1 -p tcp --dport 4172 -j ACCEPT
# iptables -I INPUT 1 -p udp --dport 4172 -j ACCEPT
# service iptables save
```

### 重启服务

```shell
# service security_gateway restart
# service connection_manager restart
```

## 安装yunjuzhen-engine

安装Ubuntu 14.x之后，获取权限

```shell
$ sudo bash 
[sudo] password for demo: 
#
```

配置网络

```shell
# cat /etc/network/interfaces
# This file describes the network interfaces available on your system
# and how to activate them. For more information, see interfaces(5).

# The loopback network interface
auto lo
iface lo inet loopback

# The primary network interface
auto eth0
iface eth0 inet static
address 192.168.10.19
netmask 255.255.255.0
gateway 192.168.10.1
```

配置DNS

```shell
# cat /etc/resolv.conf 
# Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)
#     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
nameserver 114.114.114.114
```

测试网络（执行安装脚本需要外网环境）

```shell
# ping baidu.com
PING baidu.com (123.125.114.144) 56(84) bytes of data.
64 bytes from 123.125.114.144: icmp_seq=1 ttl=47 time=23.0 ms
```

将`yunjuzhen-engine-4.3.23043-installer.tgz`放到Ubuntu 14.x虚拟机上之后，解压

```shell
$ tar zxvf yunjuzhen-engine-4.3.23043-installer.tgz
```

获取权限安装

```shell
$ sudo bash 
[sudo] password for demo: 
# ./install.sh
```

安装结束之后，可以看到

```shell
正在处理用于 ureadahead (0.100.0-16) 的触发器 ...
 * Stopping Tomcat servlet engine tomcat6                                                                                                    [ OK ] 
 * Starting Tomcat servlet engine tomcat6                                                                                                    [ OK ] 
正在读取软件包列表... 完成
正在分析软件包的依赖关系树       
正在读取状态信息... 完成       
升级了 0 个软件包，新安装了 0 个软件包，要卸载 0 个软件包，有 134 个软件包未被升级。
cleaning up dhcp leases
rm: 无法删除"/var/lib/dhcp/*": 没有那个文件或目录
```

并且通过  `https://192.168.10.19:8443`打开web 管理界面

![VDI管理界面](http://oydlbqndl.bkt.clouddn.com/VDI管理界面.png)

## 安装agent软件（windows）

Hyhive上需要有已经启动的windows虚拟机

### 安装

在windows虚拟机上安装`PCoIP_agent`和`flashvdi-desktop-agent`，所有选项下一步即可。

**推荐这两个代理软件不要直接用windows镜像上的，版本混合出现异常状况不好排查，最好是现场安装好windows虚拟机之后再安装agent**

# 配置VDI web管理界面

打开VDI web管理界面，默认管理员账户和密码为`admin/Welcome123`

## 配置云帐号

在*资源管理*中*配置云帐号*

![配置云帐号](http://oydlbqndl.bkt.clouddn.com/配置云帐号.png)

1. `OpenStack提供者`选`OpenStack Private Cloud`
2. `认证终点URL`选`http://IP:5000/v2.0`，该IP为控制节点能访问到的IP
3. `NAT地址`为`IP`，该IP为控制节点外部IP
4. `认证方式`为`用户名和密码`
5. `租户名`为项目名
6. `用户名`为项目中对虚拟机有管理权限的用户
7. `密码`为对应用户密码

![云平台区域](http://oydlbqndl.bkt.clouddn.com/云平台区域.png)

`云平台区域`选择`RegionOne`

配置正常之后可以看到

![云平台正常配置](http://oydlbqndl.bkt.clouddn.com/云平台正常配置.png)

## 配置标准模版

### 准备

制作标准模版需要OpenStack宿主机打开`metadata`服务。

配置如下：

配置文件为`/etc/nova/nova.conf`

``` shell
[DEFAULT]
#metadata_host = $my_ip
#metadata_port = 8775
metadata_listen=0.0.0.0
metadata_listen_port=8775

[neutron]
service_metadata_proxy = true
metadata_proxy_shared_secret=123456
```

配置文件为`/etc/neutron/l3_agent.ini`

```shell
[DEFAULT]
enable_metadata_proxy = true
metadata_port = 9697
metadata_proxy_socket = /var/lib/neutron/metadata_proxy
```

配置文件为`/etc/neutron/metadata_agent.ini`

```shell
[DEFAULT]
nova_metadata_ip =10.0.20.25   #使用本机IP，暂定  
metadata_proxy_shared_secret = 123456   #与nova.conf中保持一致    
```

配置文件为`/etc/neutron/dhcp_agent.ini`

``` shell
[DEFAULT]
enable_isolated_metadata = true
#force_metadata = true
```

重启服务：

``` shell
# systemctl restart openstack-nova-api
# systemctl restart neutron-l3-agent
# systemctl restart neutron-metadata-agent
# systemctl restart neutron-dhcp-agent
```

#### 验证

验证是否打开`metadata`服务，通过需要被导入制作成镜像的虚拟机，在浏览器中打开`http://169.254.169.254/openstack/latest`是否出现字符，例如

![虚拟机验证是否打开metadata](http://oydlbqndl.bkt.clouddn.com/虚拟机验证metadata是否开启.png)



### 从虚拟机导入标准模板

**这个标准模版制作的过程，是在后台将安装好了agent软件的windows虚拟机拍摄快照，然后将快照制作成镜像上传到`Glance`中，再创建的桌面就是直接从标准模版中创建出虚拟机。**

![由虚拟机导入标准模版](http://oydlbqndl.bkt.clouddn.com/由虚拟机导入标准模版.png)

选择`导入标准模版`，选择的虚拟机为安装好agent软件的windows虚拟机。

![标准模版名称](http://oydlbqndl.bkt.clouddn.com/标准模版名称.png)

填写`标准模版名称`以及`描述`（星号为必填，`描述`非必填）

![标准模版导入设置](http://oydlbqndl.bkt.clouddn.com/标准模版导入设置.png)

1. `VM类型`为`flavor`，可在后台查看

   ```shell
   # nova flavor-list 
   +--------------------------------------+--------------------------------------+-----------+------+-----------+------+-------+-------------+-----------+
   | ID                                   | Name                                 | Memory_MB | Disk | Ephemeral | Swap | VCPUs | RXTX_Factor | Is_Public |
   +--------------------------------------+--------------------------------------+-----------+------+-----------+------+-------+-------------+-----------+
   | 00f46381-bbbe-46a2-9286-6dfbc0670b7f | 00f46381-bbbe-46a2-9286-6dfbc0670b7f | 512       | 0    | 0         |      | 1     | 1.0         | True      |
   | 03292da9-a158-408e-850e-8918eabfa6f3 | 03292da9-a158-408e-850e-8918eabfa6f3 | 512       | 0    | 0         |      | 1     | 1.0         | True      |
   ```

   `flavor`可以理解为虚拟机的硬件配置，包括`vCPU`、`内存`、`硬盘`以及`其他属性`

2. `密钥对`空白即可

3. `安全群组`即为OpenStack防火墙，选`defult`即可

4. `网络`选择对应OpenStack中网络，按照实际情况选择即可


配置成功之后，可以看到`标准模版`界面有状态为`准备好`的模版

![](http://oydlbqndl.bkt.clouddn.com/Snipaste_2017-11-09_22-07-11.png)

并且在Hyhive的管理界面中，可以看到新建的镜像`win7-vdi-test-7-M8LNXWR8`

![](http://oydlbqndl.bkt.clouddn.com/Snipaste_2017-11-09_22-08-51.png)

## 创建桌面池

在VDI的管理界面中，桌面池相当于Hyhive的虚拟机，创建好模板之后，可通过模板创建桌面池。

![](http://oydlbqndl.bkt.clouddn.com/Snipaste_2017-11-14_11-57-49.png)

1. `可用区域`：没有则不填写
2. `VM类型`：为虚拟机硬件配置信息，Disk为0没关系
3. `密钥对`：没有可不填写
4. `安全群组`：为防火墙群组
5. `网络`：为虚拟机网络
6. `活动目录域`：WORKGROUP即可
7. `激活方法`：默认即可
8. `时区`：默认即可

完全创建好之后，可以在Hyhive界面看到已经有创建出来的两台虚拟机

![](http://oydlbqndl.bkt.clouddn.com/Snipaste_2017-11-14_12-02-55.png)

并且在VDI的管理界面可以看到已经创建好了的两个桌面

![](http://oydlbqndl.bkt.clouddn.com/Snipaste_2017-11-14_12-05-58.png)

通过客户端可以看到有新的桌面

![](http://oydlbqndl.bkt.clouddn.com/Snipaste_2017-11-14_12-08-39.png)

登录即可。

## 配置手动桌面池

手动模版一般是为了物理机做的，但是有些情况比较特殊，比如说带有GPU，而且GPU数量不够做成标准模版，这时就可以通过手动桌面池，直接将虚拟机做成桌面通过Client进行登录。

### VDI管理界面

在VDI`资源管理`-`桌面池`界面创建手动桌面池

![](http://oydlbqndl.bkt.clouddn.com/Snipaste_2017-11-09_22-23-32.png)

`下一步`中`活动目录域`选择`WORKGROUP`即可，`桌面数目`按照实际情况选择，测试场景只有一个虚拟机需要做成手动桌面，次数选择`1`，其他默认即可

![](http://oydlbqndl.bkt.clouddn.com/Snipaste_2017-11-09_22-26-53.png)

`授权用户和用户组`选择前面创建的用户即可。

创建完成之后，在`桌面池`界面中可以看到已经创建了的`手动动态桌面`

![](http://oydlbqndl.bkt.clouddn.com/Snipaste_2017-11-09_22-29-19.png)

### WINDOWS虚拟机

windows虚拟机上安装代理软件`agent daas`以及`PCoIP_agent_release_installer_2.5.4.1196_graphics`。在安装过程中，出现选择`桌边型`和`数据中心或云`，选择`数据中心或云`

![PCoIP Agent安装](http://oydlbqndl.bkt.clouddn.com/PCoIP Agent安装.png)

安装完成之后，配置注册表。

在`运行`中通过`regedit`打开`注册表`，在`HKEY_LOCAL_MACHINE`-`SOFTWARE`下，通过右键点击`SOFTWARE`，`新建`-`项`

![注册表编辑器新建项](http://oydlbqndl.bkt.clouddn.com/注册表编辑器新建项.png)

新建的`项`为`Daas`，在项`Daas`中，右击空白处，通过`新建`-`字符串值`，新建两个字符串值，分别为`Server`：`VDI服务器IP地址`；`Pool`：`手动池名称`

![](http://oydlbqndl.bkt.clouddn.com/Snipaste_2017-11-09_22-32-23.png)

打开`services.msc`查看`Daas Agent`服务是否开启，如果没有，手动打开，如果已经开启，将该服务重启

![](http://oydlbqndl.bkt.clouddn.com/Snipaste_2017-11-09_22-35-21.png)

如果出现异常状况，例如`Daas Agent`服务无法重启，则直接重启虚拟机即可。

### 登录

配置正常之后，在VDI的`桌面`界面可以看到状态为`已启动`的桌面

![](http://oydlbqndl.bkt.clouddn.com/Snipaste_2017-11-09_22-44-36.png)

此时可通过`PCoIP Client`软件直接登录到桌面上

![](http://oydlbqndl.bkt.clouddn.com/Snipaste_2017-11-09_22-46-20.png)

`主机地址`为`cm_sg`服务器IP；`连接名称`随意，也可不填。

点击`下一步`之后，可看到出现证书告警，直接选择`连接不安全`即可

![](http://oydlbqndl.bkt.clouddn.com/Snipaste_2017-11-09_22-48-32.png)

在`用户名`处输入VDI管理界面创建的用户`登录名`，`密码`为对应用户的密码

![](http://oydlbqndl.bkt.clouddn.com/Snipaste_2017-11-09_22-52-27.png)

登录成功之后，选中桌面，然后点击连接即可。

![](http://oydlbqndl.bkt.clouddn.com/Snipaste_2017-11-14_11-42-48.png)

# 更换lic授权

在连接桌面的时候，若是出现没有许可证的报错，解决办法为更换掉已过期的授权文件

![](http://oydlbqndl.bkt.clouddn.com/Snipaste_2017-11-09_22-54-38.png)

通过`lic服务器`的`8090`端口登录到*lic授权管理界面*

![](http://oydlbqndl.bkt.clouddn.com/Snipaste_2017-11-09_22-57-46.png)

点击右上角`Administrator`即可登录。默认`username`为`admin`；`password`为`admin`。

点击左下角`Vendor Daemons Configuration`，进入到添加`license`界面

![](http://oydlbqndl.bkt.clouddn.com/Snipaste_2017-11-09_23-01-22.png)

点击`Import License`即可提交新的license文件。新的license文件为`Test_license_PCoIP_GPU_Session_20180502.lic`和`Test_license_PCoIP_Session_20180101.lic`，提交的时候选中`Overwrite License File on License Server`按钮

![](http://oydlbqndl.bkt.clouddn.com/Snipaste_2017-11-09_23-04-04.png)

提交之后，点击`Vendor Daemons Configuration`界面`TERADICI`右边`Administrator`按钮，可以看到已经提交的两个授权文件

![](http://oydlbqndl.bkt.clouddn.com/Snipaste_2017-11-09_23-07-56.png)

后台重启`lmadmin`服务即可

![](http://oydlbqndl.bkt.clouddn.com/Snipaste_2017-11-09_23-05-41.png)

完成。重新用客户端连接桌面即可。