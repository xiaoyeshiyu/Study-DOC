[TOC]
# openstack相关
* `nova boot --flavor 31a30ebc-0531-4ac3-8156-aab3084704fc --boot-volume e0f1bc5e-b181-4498-a471-79fa039b2304 --access-ip-v4 10.11.104.178 --nic net-id=48f6b060-2453-4d5c-98c5-5c054c80628c test-410` 后台命令手动启动一个实例
* `mysqldump -h10.11.104.212 -uroot -pdaemon.mysql --all-databases  > mysql-23-03-2017.sql` 备份数据库
* `nova flavor-key cf0eff54-85c1-4a80-bd17-08ea7db0dd3a set hw:cpu_sockets=1` 设置flavor中cpu的sockets数（windows7等桌面系统最多支持2路CPU）
* `nova flavor-key cf0eff54-85c1-4a80-bd17-08ea7db0dd3a set hw:cpu_cores=2` 设置flavor中cpu的core数
* `nova flavor-key cf0eff54-85c1-4a80-bd17-08ea7db0dd3a set hw:cpu_threads=2` 设置flavor中cpu的thread数
* 附加更换光盘
  * `virsh attach-disk win7 /infinityfs/sharedir/Windows7_lite.iso hdb --sourcetype block --driver qemu --subdriver raw --type cdrom` 制作windows镜像时可能使用
  * `virsh attach-disk {instance_name} {iso_path} hda --sourcetype block  --driver qemu --subdriver raw  --type cdrom`
* 删除僵尸卷，这里通过hack sql的方式实现
  * `select * from cinder.snapshots where id = "3cebadad-e0ba-4727-aa8b-fe5030903b1e";`
  * `update cinder.snapshots set deleted=1, deleted_at="2012-10-10 14:56:30", status="deleted" where id = "1b32b1bd-7c15-49b4-89e2-6e77d01a64de";`
* os_distro
* 查询启动rabbitmq插件
  * `rabbitmq-plugins list`
  * `rabbitmq-plugins enable rabbitmq_management` 这个插件不启用rabbitmq组件会报错"Failed connect to 192.168.1.11:15672;Connection refused"
* 查看兼容cpu特性
  * `virsh capabilities`
* 增加port可用ip，实现一个port可以使用多个ip
  * neutron port-update <port-uuid> --allowed-address-pairs type=dict list=true mac_address=<mac_address>,ip_address=<ip_cidr>
* 统计卷实际大小
  * `rbd diff hyhive_volumes/volume-161183ed-6a5b-4436-ba5f-f850332b1307 | awk '{ SUM += $2 } END { print SUM/1024/1024 " MB" }'`
* 卷导出 
  * `rbd export volumes/volume-46833583-48dc-4cda-b520-5ffd0e6a7dee /infinityfs/export/导出的虚拟机卷.raw`
* 卷转让的使用方法（不同项目之间转让卷）
  * `cinder transfer-create 卷ID `&& 通过界面接受卷转让或命令`cinder transfer-accept 转让ID 转让密匙 `，注意需要export OS_TENANT_NAME （变量可能不同，具体见keystonerc）接受转让的项目名

* 创建网口时指定mac地址，虚拟机有特殊要求，具体如软件授权绑定mac地址
  * `neutron port-create --fixed-ip ip_address=10.11.108.208 --mac-address fa:16:3e:e6:c4:cc 呼叫中心业务区`
  * `nova interface-attach --port-id 771dc7d8-0167-423b-893f-e2c2c6f904d4 a93a317d-c972-4b85-891a-864982afe37` port创建成功后附加给实例
## 实例跨平台迁移流程(openstack to openstack)

* 虚拟机迁移主要为卷数据的迁移，从源平台导出raw镜像之后上传到目标平台，然后用同样的配置重建虚拟机不同平台导出为避免二次传输通常直接通过nfs知道导出到目标平台，这里注意导出的卷全部是大文件，为尽量避免导出进程的深度睡死挂载nfs时使用如下参数`mount -t nfs -o bg,hard,intr 192.168.1.11:/infinityfs1/images /mnt`

* 导出的卷raw格式通常较大，直接上传为镜像然后创建虚拟机耗时长，失败率高，这里我们仍然采用命令方式直接hack底层卷来提高效率。

  * 首先导出迁移虚拟机的raw格式卷到新平台，通常放到infinity的共享目录下，导出速度视网络环境和集群环境不同而不同
  * 在新平台上创建同样大小的卷，查询并记下该卷的ID
  * 删除该卷在infinity上的实体，注意根据具实际情况_**正确填写pool名和卷实际ID**_，这个操作是危险操作一定要确认别删错了卷`rbd -p ${volumes_pool_name} rm volume-${volume_id}`，注意infinity中的卷名和openstack中的卷ID不完全相同但有联系
  * 上传raw镜像到新平台上替换删除的卷实体，这里注意卷实际ID一定要和删除的卷ID一样`rbd -p ${volumes_pool_name} --image-format 2 import ${volume_file_path} volume-${volume_id}`
  * 上传完成后记得将作为系统盘的卷设置为bootable可启动，普通数据卷可以不用设置这个`cinder set-bootable ${volume_id} True`
  * 界面创建新的虚拟机，使用已经存在的卷


## Hyhive启动流程
1. galera_new_cluster 启动数据库，第一个节点上使用此命令，启动成功后其它mariadb节点直接用systemctl start mariadb启动

2. pcs cluster start --all 启动pacemaker集群

3. pcs resource cleanup --all --force 强制清除所有资源的状态与错误计数

### 其它pacemaker集群管理相关
* pcs status 查看所用群集和服务状态

* pcs status cluster 查看集群运行状态

* pcs status corosync 查看corosync服务状态

* pcs cluster stop node1 停止群集

* pcs cluster start --all 启动所有群集

* pcs cluster standby node1 将节点置为后备standby状态

* pcs cluster unstandby node11 解除节点的手背standby状态

* pcs cluster destroy --all 删除群集，[--all]同时恢复corosync.conf文件

* pcs resource cleanup ClusterIP 清除指定资源的状态与错误计数

* pcs stonith cleanup fence-nova 清除fence-nova资源的状态与错误计数

## troubleshooting

* 目前Hyhive使用的openstack为newton版本，openvswitch-agent存在一个bug，集群启动后或异常关机重启后可能网络不通，如果遇到尝试进行以下操作
  * `systemctl stop neutron-openvswitch-agent`停止openvswitch-agent服务
  * `lsof -i :6633 `查看6633端口是否被占用，kill掉所有占用6633端口的进程
  * 重启neutron-server和neutron-openvswitch-agent服务，确保openvswitch运行正常
* openstack-nova-compute服务无法启动
  * 日志反复报错
    > NovaExecption: Unsupported VIF type binding_failed convert '_nova_to_osvif_vif_binding_failed'

  * 这个问题一般是节点某台虚拟机的网卡问题，解决方法一般如下，`ovs-vsctl show`查看br-int、br-tun、br-ex都为正常，`nova reset-state 虚拟机ID`将该虚拟机状态设置为error，然后尝试启动openstack-nova-compute服务，`nova reset-state --active 虚拟机ID`重置虚拟机状态，然后重启该虚拟机（这个可以在界面操作）。

  * 如果openstack-nova-compute仍然无法启动，`ovs-vsctl del-br br-int` && `ovs-vsctl del-br br-tun`删除掉这两个网桥，br-ex不要动，重启neutron-server、openvswitch和neutron-openvswitch-agent服务，`ovs-vsctl show`查看br-int、br-tun、br-ex都为正常，再`nova reset-state 虚拟机ID`将该虚拟机状态设置为error，然后尝试启动openstack-nova-compute服务，`nova reset-state --active 虚拟机ID`重置虚拟机状态，然后重启该虚拟机。

